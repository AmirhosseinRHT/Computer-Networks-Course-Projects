# به نام خدا
## پروژه اول شبکه های کامپیوتری
##### علی ممتحن 810100213 امیرحسین راحتی 810100144
#### بررسی webrtc
پروتکلی است که در آن دو کلاینت بدون نیاز به یک سرور برای ارتباط با آن ، مستقیم با هم ارتباط میگیرند و پیام و اطلاعات خود را جابجا میکنند .
در این روش ، دو کلاینت ابتدا بوسیله یک signaling server با هم ارتباط میگیرند و SDP , candidate را با هم به اشتراک میگذارند . 
این ویژگی ها که در ادامه توضیح داده میشود ، باعث میشود دو کلاینت با همدیگر مستقیم ارتباط بگیرند و سرور از ارتباط حذف شود. اینکار باعث میشود تاخیر به حداقل برسد .
##### ویژگی ice
یکی از مزیت‌های این پروتکل ، ICE یا Interactive Connectivity Establishment است. ICE پروتکلی است
که مشکلات NAT و فایروال را برای ارتباط peer-to-peer از میان برمی‌دارد.
این روش بدین صورت عمل می کند که طرفین ارتباط با اشتراک گذاری مسیرهایی که می توانند با هم ارتباط برقرار کنند
( که به هر کدام یک candidate گفته می شود) بهترین مسیر برای برقراری ارتباط را تشخیص می دهند 
و با حذف موانع ذکر شده در بالا با هم ارتباط را برقرار می کنند.
##### ویژگی sdp
پروتکل Session Description Protocol پروتکلی است که به وسیله آن امکان ارسال فایل های چند رسانه ای در بستر WebRTC امکان پذیر می شود.
در واقع این پروتکل باعث ایجاد زبان مشترک بین دو دستگاه می شود و دو دستگاه با به اشتراک گذاری sdp هایشان با هم از نوع فایلی که قرار است ارسال شود،
پروتکلی که تحت آن پیام ها ارسال می شود ، codec و سایر تنظیمات لازم برای برقراری ارتباط آگاه می شوند.

##### ویژگی signaling server
ابن سرور کمک میکند ابتدا دو کلاینت بتوانند به روش سنتی با هم ارتباط بگیرند . هر کلاینت به این سرور وصل میشود و درخواست میدهد که میخواهد به کدام کلاینت وصل شود
. سپس اطلاعات خود نظیر sdp , ... را ارسال میکند و سرور به کلاینت دیگر منتقل میکند . سپس دو کلاینت مستقیم به هم وصل میشوند و واین سرور کارش تمام میشود.
سرور stun : این سرور به کلاینت‌ها کمک می‌کند که آدرس خارجی خود را به دست آورند.
سرور turn :به آن Relay Server هم گفته می‌شود. این سرور هم مانند TURN Server به کلاینت‌ها کمک می‌کند 
که آی‌پی خارجی خود را به دست آورند. علاوه بر آن، مدیا را از کلاینت‌ها به یکدیگر منتقل می‌کند.

## پیاده سازی

یک سرور tcp به عنوان signalling server ایجاد میشود که بوسیله کتابخانه winsock2 پیاده سازی میشود . توابع مربوط به سرور و کلاینت tcp در تصویر زیر قابل مشاهده است . 
![tcp1](https://github.com/AliMomtahen/CN_CA1/assets/102304346/57730bc0-9f63-4ca2-a464-2315a55e3f4b)
![tcp2](https://github.com/AliMomtahen/CN_CA1/assets/102304346/e13cb7a4-5cae-4ce4-a13d-71e665f37baf)
![tcpclient1](https://github.com/AliMomtahen/CN_CA1/assets/102304346/562f69a9-a7ae-41c3-8989-612b59ab0a44)
![tcpclient2](https://github.com/AliMomtahen/CN_CA1/assets/102304346/e54a9314-9fbe-4b64-b335-0eb59433e857)
برای پیاده سازی ارتباط با webrtc از کتاب خانه libdatachannel استفاده میکنیم که قبلا بیلد شده است .
ابتدا یک oferrer  و یک answerrer داریم که همان کلاینت های ما هستند .
ابتدا oferrer اطلاعات sdp  کانفیگ را به signaling server ارسال میکند . 
سپس منتظر پاسخ answerer از سرور میماند تا کانفیگ و sdp و candidate ها را دریافت کند. 
نهایتا با برقراری ارتباط ، سرور کنار میرود و دو کلاینت با هم ارتباط برقرار میکنند . بخش های مهم این کد عبارتند از : بخش دریافت و اضافه کردن description , candidate ها
![desAndcand](https://github.com/AliMomtahen/CN_CA1/assets/102304346/337185c6-261c-443b-99f9-cc04fa3ea016)

بخش مربوط به افزودن callback ها :
![callbacks](https://github.com/AliMomtahen/CN_CA1/assets/102304346/820066bd-82d9-493a-9fce-a92ac1bed2b1)
![server](https://github.com/AliMomtahen/CN_CA1/assets/102304346/cc5317c5-da85-41ba-8ab3-cff94a91247f)
![clientRecieve](https://github.com/AliMomtahen/CN_CA1/assets/102304346/a7bab9d5-7072-40c3-b4a1-47e5e320934a)

نمونه اجرای اتصال دو کلاینت  و ارسال پیام:
![test](https://github.com/AliMomtahen/CN_CA1/assets/102304346/7b6afda1-291b-42df-b0a6-cca0787aae87)

بخش دریافت صدا از میکروفون و پخش صدا:
در این بخش بوسیله کتابخانه QAudioSource , QMediaDevices صدا از میکروفون سیستم دریافت میشود و 
در یک بافر ذخیره میشود و این بافر قرار است ارسال و توسط کلاینت دیگر پخش شود . 

![audio1](https://github.com/AliMomtahen/CN_CA1/assets/102304346/32035d5b-860f-4b9f-91cc-e14bbc9f0867)


ذخیره صدا در بافر :
![audioToBuffer](https://github.com/AliMomtahen/CN_CA1/assets/102304346/174d48a5-1255-46eb-a671-9e7fa2148033)

سپس این بافر ارسال میشود و در مقصد بوسیله توابع کلاس audioOut ، توسط خروجی صدای سیستم اجرا و پخش میشود . 

![speakerhpp](https://github.com/AliMomtahen/CN_CA1/assets/102304346/62e2cc91-b319-48f4-943f-980ffc377753)

تابع play  که بخش اصلی کار را انجام میدهد:
![playSpeaker](https://github.com/AliMomtahen/CN_CA1/assets/102304346/7059bddb-92e9-4944-b1cf-8ac613a72804)

در بخش ui هم کلید هایی برای رابط کاربری طراحی شده است :
![ui](https://github.com/AliMomtahen/CN_CA1/assets/102304346/d43f6241-c35b-4fd8-b95a-6916c03a6818)


نهایتا با اجرای دو کلاینت و اتصال آن ها و سپس ارسال بافرهای صدای ورودی و اجرا در سمت دیگر ، تماس صوتی برقرار میشود . 
